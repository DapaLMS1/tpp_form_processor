<!-- Prototype Canvas: Training Plan Proposal Editor (Refactored) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TPP Editor Prototype</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .accordion-content { transition: max-height .3s ease, padding .3s ease; overflow: hidden; }
    .segmented-control input[type=radio]{display:none;}
    .segmented-control input[type=radio]:checked + label{background:#4B0082;color:white;font-weight:700;}
    .spinner{border:3px solid rgba(0,0,0,.08);border-top:3px solid #4B0082;border-radius:50%;width:20px;height:20px;animation:spin 1s linear infinite;}@keyframes spin{to{transform:rotate(360deg);}}
  </style>
</head>
<body class="bg-gray-50 p-6 text-gray-800">

  <h1 class="text-3xl font-bold text-center text-[#4B0082] mb-6">TPP Editor — Prototype</h1>

  <!-- Upload Area -->
  <section class="max-w-xl mx-auto mb-6 bg-white p-4 rounded shadow">
    <label class="block text-sm font-semibold">Upload File</label>
    <input id="fileInput" type="file" accept="application/pdf,image/*" class="mt-2" />
    <div id="uploadStatus" class="mt-3 text-sm"></div>
  </section>

  <!-- Form Container -->
  <section class="max-w-3xl mx-auto bg-white p-6 rounded shadow space-y-4">

    <button class="w-full flex justify-between p-3 bg-indigo-100 rounded accordion-header" data-target="p1">
      <span class="font-semibold text-indigo-900">1. Apprentice / Trainee Personal Details</span>
      <span>▼</span>
    </button>

    <div id="p1" class="accordion-content p-4" style="max-height:1200px;">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="text-xs font-semibold">Given Name</label><input data-field="givenName" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Family Name</label><input data-field="familyName" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Middle Name</label><input data-field="middleName" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Date of Birth</label><input data-field="dob" type="text" placeholder="DD/MM/YYYY" pattern="\d{2}/\d{2}/\d{4}" class="w-full p-2 border rounded"/></div>
        <div class="md:col-span-2">
          <label class="text-xs font-semibold">Gender</label>
          <div class="segmented-control inline-flex border rounded mt-1">
            <input id="gM" name="gender" type="radio" value="Male"/><label for="gM" class="px-3 py-1 border-r">Male</label>
            <input id="gF" name="gender" type="radio" value="Female"/><label for="gF" class="px-3 py-1 border-r">Female</label>
            <input id="gU" name="gender" type="radio" value="Unspecified"/><label for="gU" class="px-3 py-1">Unspecified</label>
          </div>
        </div>
        <div><label class="text-xs font-semibold">Aboriginal or Torres Strait Islander origin?</label>
          <div class="segmented-control inline-flex border rounded mt-1">
            <input id="atsiY" name="atsi" type="radio" value="Yes"/><label for="atsiY" class="px-3 py-1 border-r">Yes</label>
            <input id="atsiN" name="atsi" type="radio" value="No"/><label for="atsiN" class="px-3 py-1">No</label>
          </div></div>
        <div><label class="text-xs font-semibold">Street Address</label><input data-field="streetAddress" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Suburb</label><input data-field="suburb" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">State</label><input data-field="state" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Postcode</label><input data-field="postcode" pattern="\d{4}" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Mobile</label><input data-field="mobile" pattern="04\d{8}" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Telephone</label><input data-field="telephone" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Support Indicator</label>
          <div class="segmented-control inline-flex border rounded mt-1">
            <input id="supY" name="supportIndicator" type="radio" value="Yes"/><label for="supY" class="px-3 py-1 border-r">Yes</label>
            <input id="supN" name="supportIndicator" type="radio" value="No"/><label for="supN" class="px-3 py-1">No</label>
          </div></div>
        <div><label class="text-xs font-semibold">Email</label><input data-field="email" type="email" class="w-full p-2 border rounded"/></div>
      </div>
    </div>

    <!-- Section 1.2 Training Details -->
    <button class="w-full flex justify-between p-3 bg-indigo-100 rounded accordion-header" data-target="p2">
      <span class="font-semibold text-indigo-900">1.2 Training Details</span>
      <span>▼</span>
    </button>
    <div id="p2" class="accordion-content p-4" style="max-height:0;">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="text-xs font-semibold">Contract Type</label><input data-field="contractType" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Employment Type</label><input data-field="employmentType" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Hours Per Week</label><input data-field="hoursPerWeek" type="number" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">TC Start Date</label><input data-field="tcStartDate" type="text" placeholder="DD/MM/YYYY" pattern="\d{2}/\d{2}/\d{4}" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">TC End Date</label><input data-field="tcEndDate" type="text" placeholder="DD/MM/YYYY" pattern="\d{2}/\d{2}/\d{4}" class="w-full p-2 border rounded"/></div>
      </div>
    </div>

    <!-- Section 1.4 RTO Details -->
    <button class="w-full flex justify-between p-3 bg-indigo-100 rounded accordion-header" data-target="p3">
      <span class="font-semibold text-indigo-900">1.4 RTO Details</span>
      <span>▼</span>
    </button>
    <div id="p3" class="accordion-content p-4" style="max-height:0;">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="text-xs font-semibold">Legal Name</label><input data-field="rtoLegalName" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">National Code</label><input data-field="rtoNationalCode" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Trading Name</label><input data-field="rtoTradingName" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">ABN</label><input data-field="rtoABN" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Start Date</label><input data-field="rtoStartDate" type="text" placeholder="DD/MM/YYYY" pattern="\d{2}/\d{2}/\d{4}" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Estimated End Date</label><input data-field="estimatedRTOEndDate" type="text" placeholder="DD/MM/YYYY" pattern="\d{2}/\d{2}/\d{4}" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Contact Name</label><input data-field="rtoContactName" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Email</label><input data-field="rtoEmail" type="email" class="w-full p-2 border rounded"/></div>
      </div>
    </div>

    <!-- Section 1.5 Employer Details -->
    <button class="w-full flex justify-between p-3 bg-indigo-100 rounded accordion-header" data-target="p4">
      <span class="font-semibold text-indigo-900">1.5 Employer Details</span>
      <span>▼</span>
    </button>
    <div id="p4" class="accordion-content p-4" style="max-height:0;">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="text-xs font-semibold">Legal Name</label><input data-field="employerLegalName" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Trading Name</label><input data-field="employerTradingName" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">ABN</label><input data-field="employerABN" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Licence No.</label><input data-field="employerLicenceNo" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Street Address</label><input data-field="employerStreetAddress" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Suburb</label><input data-field="employerSuburb" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">State</label><input data-field="employerState" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Postcode</label><input data-field="employerPostcode" pattern="\d{4}" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Contact Name</label><input data-field="employerContactName" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Email</label><input data-field="employerEmail" type="email" class="w-full p-2 border rounded"/></div>
      </div>
    </div>

    <!-- Section 1.6 Sign-Off -->
    <button class="w-full flex justify-between p-3 bg-indigo-100 rounded accordion-header" data-target="p5">
      <span class="font-semibold text-indigo-900">1.6 Acceptance of Agreement (Sign-off)</span>
      <span>▼</span>
    </button>
    <div id="p5" class="accordion-content p-4" style="max-height:0;">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="text-xs font-semibold">RTO Print Name</label><input data-field="rtoPrintName" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">RTO Position</label><input data-field="rtoPosition" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">RTO Date</label><input data-field="rtoDate" type="text" placeholder="DD/MM/YYYY" pattern="\d{2}/\d{2}/\d{4}" class="w-full p-2 border rounded"/></div>

        <div><label class="text-xs font-semibold">Employer Position</label><input data-field="employerPosition" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Employer Date</label><input data-field="employerDate" type="text" placeholder="DD/MM/YYYY" pattern="\d{2}/\d{2}/\d{4}" class="w-full p-2 border rounded"/></div>

        <div><label class="text-xs font-semibold">Apprentice Print Name</label><input data-field="apprenticePrintName" class="w-full p-2 border rounded"/></div>
        <div><label class="text-xs font-semibold">Apprentice Date</label><input data-field="apprenticeDate" type="text" placeholder="DD/MM/YYYY" pattern="\d{2}/\d{2}/\d{4}" class="w-full p-2 border rounded"/></div>
      </div>
    </div>

  </section>

<script type="module">
    // accordion.js (inline prototype)
    document.querySelectorAll('.accordion-header').forEach(h => {
      h.addEventListener('click', () => {
        const target = document.getElementById(h.dataset.target);
        const open = target.style.maxHeight !== '0px';
        if (open) {
          target.style.maxHeight = '0px';
          target.style.paddingTop = '0px';
          target.style.paddingBottom = '0px';
        } else {
          const inner = target.scrollHeight;
          target.style.maxHeight = inner + 40 + 'px';
          target.style.paddingTop = '1rem';
          target.style.paddingBottom = '1rem';
        }
      });
    });

    // formMapper.js (inline prototype)
    const map = {};
    document.querySelectorAll('[data-field]').forEach(el => map[el.dataset.field] = el);
    window.populate = (obj={}) => {
      Object.entries(obj).forEach(([k,v]) => {
        if (k === 'gender') {
          const r = document.querySelector(`input[name="gender"][value="${v}"]`);
          if (r) r.checked = true;
        } else if (map[k]) {
          map[k].value = v;
        }
      });
    };

    // fileUpload.js (inline prototype)
    const fileInput = document.getElementById('fileInput');
    const statusBox = document.getElementById('uploadStatus');

    fileInput.addEventListener('change', async () => {
      const file = fileInput.files[0];
      if (!file) return;

      statusBox.innerHTML = '<span class="spinner"></span> Uploading...';

      const fd = new FormData();
      fd.append('file', file);

      try {
        const res = await fetch('/api/processDocument', { method:'POST', body:fd });
        const json = await res.json();
        if (json.isValidTPP) {
          window.populate(json.extractedData);
          statusBox.textContent = 'Form populated!';
        } else {
          statusBox.textContent = 'Invalid document.';
        }
      } catch(e) {
        statusBox.textContent = 'Error processing file.';
      }
    });
  </script>

</body>
</html>
